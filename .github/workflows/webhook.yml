name: Webhook CI

on: [push, pull_request]

jobs:
  pull_request_ci:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}
    steps:
      - name: Webhook to gitlab
        uses: joelwmale/webhook-action@master
        with:
          url: ${{ secrets.BACKSTAGE_WEBHOOK_URL }}
          headers: ''
          body: |
            {
              'msg_type': 'interactive',
              'card': {
                'config': {
                  'wide_screen_mode': true,
                  'enable_forward': true
                },
                'header': {
                  'title': {
                    'content': 'Backstage-app Triggered ${{github.event_name}}',
                    'tag': 'plain_text'
                  },
                  'template': 'turquoise'
                },
                'elements': [
                  {
                    'tag': 'note',
                    'elements': [
                      {
                        'tag': 'lark_md',
                        'content': 'branch:${{github.ref_name}}'
                      }
                    ]
                  },
                  { 'tag': 'hr' },
                  {
                    'tag': 'note',
                    'elements': [
                      {
                        'tag': 'lark_md',
                        'content': '${{github.head_ref}}'
                      }
                    ]
                  },
                  {
                    'tag': 'action',
                    'actions': [
                      {
                        'tag': 'button',
                        'text': {
                          'tag': 'plain_text',
                          'content': '查看 PR'
                        },
                        'type': 'default',
                        url: '${{github.head_ref}}'
                      }
                    ]
                  }
                ]
              }
            }
